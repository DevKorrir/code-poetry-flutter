name: Flutter Release APK

on:
  push:
    tags:
      - 'v*.*.*' # triggers on tags like v1.0.0, v1.2.3

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # Step 1: Checkout the repo
      - uses: actions/checkout@v3

      # Step 2: Set up Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # Step 3: Install dependencies
      - name: Install dependencies
        run: flutter pub get

      # Step 3.5: Setup Android Signing
      - name: Setup Android Signing
        run: |
           if [ -n "$ANDROID_KEYSTORE_BASE64" ]; then
             echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks
             echo "storePassword=$ANDROID_STORE_PASSWORD" > android/key.properties
             echo "keyPassword=$ANDROID_KEY_PASSWORD" >> android/key.properties
             echo "keyAlias=$ANDROID_KEY_ALIAS" >> android/key.properties
             echo "storeFile=upload-keystore.jks" >> android/key.properties
           fi
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}

      # Step 3.6: Create .env file
      - name: Create .env file
        run: |
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" > .env
          echo "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> .env
          echo "GITHUB_CLIENT_ID=${{ secrets.GITHUB_CLIENT_ID }}" >> .env
          echo "GITHUB_CLIENT_SECRET=${{ secrets.GITHUB_CLIENT_SECRET }}" >> .env
          echo "GITHUB_REDIRECT_URL=${{ secrets.GITHUB_REDIRECT_URL }}" >> .env

      # Step 4: Build release APK
      - name: Build release APK
        run: flutter build apk --release

      # Step 5: Upload APK to GitHub Release
      - name: Upload APK to Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/app/outputs/flutter-apk/app-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
